#!/bin/bash
set -e

function show_usage(){
  USAGE="Usage: ${0##*/} [options...]
Options:
-r, --remove                   Exit K8S cluster and remove data
-h, --help                     This help text
"

  echo "${USAGE}"
}

function get_options(){
  local PROGNAME="${0##*/}"
  local SHORTOPTS="rh"
  local LONGOPTS="remove,help"
  local PARSED_OPTIONS=""

  PARSED_OPTIONS="$(getopt -o "${SHORTOPTS}" --long "${LONGOPTS}" -n "${PROGNAME}" -- "$@")" || exit 1
  eval set -- "${PARSED_OPTIONS}"

  # extract options and their arguments into variables.
  while true ; do
      case "$1" in
          -r|--remove)
              export EX_EXIT="true"
              shift
              ;;
          -h|--help)
              show_usage
              exit 0
              shift
              ;;
          --)
              shift
              break
              ;;
          *)
              echo "Option error!" 1>&2
              echo $1
              exit 1
              ;;
      esac
  done
}

function main(){
  get_options "$@"
  local EXIT="${EX_EXIT}"

  source "/root/.bashrc"
  local IPADDR="${EX_IPADDR}"
  local ETCD_CLIENT_PORT="${EX_TCD_CLIENT_PORT}"
  local K8S_VERSION="${EX_K8S_VERSION}"
  local K8S_PORT="${EX_K8S_PORT}"

  # Find an API server
  local APISERVER=""
  if curl -sf "127.0.0.1:${K8S_PORT}" &>/dev/null; then
    APISERVER="127.0.0.1:${K8S_PORT}"
  else
    # If API server is not running on local, searching it from other nodes.
    local NODE_LIST="$(curl -sf 127.0.0.1:${ETCD_CLIENT_PORT}/v2/keys/registry/minions \
                      | jq -r .node.nodes[].key \
                      | sed -n "s/.*\/\(.*\)$/\1/p")"
    local NODE=""
    for NODE in ${NODE_LIST}; do
      if curl -sf "${NODE}:${K8S_PORT}" &>/dev/null; then
        APISERVER="${NODE}:${K8S_PORT}"
        break
      fi
    done
  fi

  # Drain node in preparation for maintenance.
  docker run \
    --net=host \
    --rm=true \
    gcr.io/google_containers/hyperkube-amd64:v${K8S_VERSION} \
    /hyperkube kubectl -s "${APISERVER}" \
    drain "${IPADDR}" --force --delete-local-data

  if [[ "${EXIT}" == "true" ]]; then
    # Exit k8s cluster
    docker run \
      --net=host \
      --rm=true \
      gcr.io/google_containers/hyperkube-amd64:v${K8S_VERSION} \
      /hyperkube kubectl -s "${APISERVER}" \
      delete node "${IPADDR}"
  fi

  # Remove k8s system pods conf
  echo '{}' | tee /etc/kubernetes/manifests-multi/kube-proxy.json &>/dev/null
  echo '{}' | tee /etc/kubernetes/manifests-multi/master-multi.json &>/dev/null
  echo '{}' | tee /etc/kubernetes/manifests-multi/addon-manager.json &>/dev/null

  echo -n "Waiting for all k8s pods stopped ..." 1>&2
  until [[ "$(docker ps | grep 'gcr.io/google_containers/hyperkube' | wc -l)" == 1 ]]; do
    echo -n "." 1>&2
    sleep 1
  done
  echo 1>&2

  if [[ "${EXIT}" == "true" ]]; then
    # Exit etcd cluster
    local MEMBER_LIST="$(curl -s http://${IPADDR}:${ETCD_CLIENT_PORT}/v2/members)"
    if [[ "${MEMBER_LIST}" == *"${IPADDR}:${ETCD_CLIENT_PORT}"* ]]; then
      local MEMBER_ID="$(curl -s "http://${IPADDR}:${ETCD_CLIENT_PORT}/v2/members" | jq -r ".members[] | select(contains({clientURLs: [\"/${IPADDR}:\"]})) | .id")"
      test "${MEMBER_ID}" && curl -s "http://${IPADDR}:${ETCD_CLIENT_PORT}/v2/members/${MEMBER_ID}" -XDELETE
      docker stop k8sup-etcd
      docker rm k8sup-etcd
      rm -rf "/var/lib/etcd/"*
    fi
  fi

  echo "Stopping k8sup-kubelet, k8sup-etcd, k8sup-flanneld, and k8sup." 1>&2
  docker stop $(docker ps -a | grep -E "k8sup-kubelet|k8sup-etcd|k8sup-flannel" | awk '{print $1}') 1>/dev/null
  docker rm $(docker ps -a | grep -E "k8sup-kubelet|k8sup-etcd|k8sup-flannel" | awk '{print $1}') 1>/dev/null
  docker rm -f $(docker ps -a | grep "k8sup" | awk '{print $1}') 1>/dev/null
}

main "$@"
